<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Autenticação — Nova Vibe RP</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #333;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .logo p {
      color: #666;
      font-size: 14px;
    }

    .form-container {
      display: none;
    }

    .form-container.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #333;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .link-btn {
      background: none;
      border: none;
      color: #667eea;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      margin-top: 15px;
      display: block;
      text-align: center;
    }

    .link-btn:hover {
      color: #764ba2;
    }

    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .alert.error {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .alert.success {
      background: #dcfce7;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }

    .password-strength {
      margin-top: 8px;
    }

    .strength-bar {
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .strength-fill {
      height: 100%;
      transition: all 0.3s ease;
      width: 0%;
    }

    .strength-text {
      font-size: 12px;
      font-weight: 500;
    }

    .form-links {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .form-links button {
      background: none;
      border: none;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      text-decoration: underline;
    }

    .form-links button:hover {
      color: #764ba2;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>Nova Vibe RP</h1>
      <p>Conecte-se ao servidor</p>
    </div>

    <!-- Login -->
    <div id="login-form" class="form-container active">
      <div id="login-alert"></div>
      <form id="login-form-element">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" required />
        </div>
        <div class="form-group">
          <label for="login-password">Senha</label>
          <input type="password" id="login-password" required />
        </div>
        <button type="submit" id="login-btn" class="btn">Entrar</button>
        <div class="form-links">
          <button type="button" id="show-register">Criar conta</button>
          <button type="button" id="show-forgot">Esqueci a senha</button>
        </div>
      </form>
    </div>

    <!-- Cadastro -->
    <div id="register-form" class="form-container">
      <div id="register-alert"></div>
      <form id="register-form-element">
        <div class="form-group">
          <label for="register-name">Nome completo</label>
          <input type="text" id="register-name" required />
        </div>
        <div class="form-group">
          <label for="register-email">Email</label>
          <input type="email" id="register-email" required />
        </div>
        <div class="form-group">
          <label for="register-password">Senha</label>
          <input type="password" id="register-password" required />
          <div class="password-strength">
            <div class="strength-bar">
              <div id="strength-fill" class="strength-fill"></div>
            </div>
            <div id="strength-text" class="strength-text">Muito fraca</div>
          </div>
        </div>
        <div class="form-group">
          <label for="register-confirm">Confirmar senha</label>
          <input type="password" id="register-confirm" required />
        </div>
        <button type="submit" id="register-btn" class="btn">Criar conta</button>
        <button type="button" id="show-login" class="link-btn">Já tenho uma conta</button>
      </form>
    </div>

    <!-- Esqueci a senha -->
    <div id="forgot-form" class="form-container">
      <div id="forgot-alert"></div>
      <form id="forgot-form-element">
        <div class="form-group">
          <label for="forgot-email">Email</label>
          <input type="email" id="forgot-email" required />
        </div>
        <button type="submit" id="forgot-btn" class="btn">Enviar link de recuperação</button>
        <button type="button" id="back-to-login" class="link-btn">Voltar ao login</button>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    // Configurar Supabase
    const supabaseUrl = 'https://czsnjdoxguldtznixcdj.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6c25qZG94Z3VsZHR6bml4Y2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMzI0NTAsImV4cCI6MjA2NzYwODQ1MH0.PCTVMRqrDD-5jsTXwQOHZP-uuNBwjbcjlfOZBidRcaU';
    
    // Corrigir a inicialização do Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

    // Navegação entre formulários
    const forms = {
      login: document.getElementById('login-form'),
      register: document.getElementById('register-form'),
      forgot: document.getElementById('forgot-form'),
    };

    // Event listeners para navegação
    document.getElementById('show-register').addEventListener('click', (e) => {
      e.preventDefault();
      showForm('register');
    });

    document.getElementById('show-login').addEventListener('click', (e) => {
      e.preventDefault();
      showForm('login');
    });

    document.getElementById('show-forgot').addEventListener('click', (e) => {
      e.preventDefault();
      showForm('forgot');
    });

    document.getElementById('back-to-login').addEventListener('click', (e) => {
      e.preventDefault();
      showForm('login');
    });

    function showForm(formName) {
      Object.keys(forms).forEach(key => forms[key].classList.remove('active'));
      forms[formName].classList.add('active');
      clearAlerts();
    }

    function showAlert(formName, message, type = 'error') {
      const alertDiv = document.getElementById(`${formName}-alert`);
      alertDiv.innerHTML = `<div class="alert ${type}">${message}</div>`;
      setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
    }

    function clearAlerts() {
      ['login', 'register', 'forgot'].forEach(f => {
        const el = document.getElementById(`${f}-alert`);
        if (el) el.innerHTML = '';
      });
    }

    // Função para verificar se o email já existe
    async function checkEmailExists(email) {
      try {
        // Primeiro, tentamos fazer login com uma senha inválida
        // Se o usuário existir, o Supabase retornará um erro específico
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: 'senha_temporaria_invalida_123456789'
        });

        // Se retornar erro de credenciais inválidas, significa que o email existe
        if (error && error.message === 'Invalid login credentials') {
          return true; // Email existe
        }

        // Se não der erro de credenciais inválidas, o email não existe
        return false;
      } catch (err) {
        // Em caso de erro inesperado, assumimos que o email não existe
        return false;
      }
    }

    // Indicador de força da senha
    document.getElementById('register-password').addEventListener('input', function() {
      const p = this.value;
      const fill = document.getElementById('strength-fill');
      const text = document.getElementById('strength-text');
      let strength = 0;

      if (p.length >= 8) strength++;
      if (/[a-z]/.test(p)) strength++;
      if (/[A-Z]/.test(p)) strength++;
      if (/[0-9]/.test(p)) strength++;
      if (/[^A-Za-z0-9]/.test(p)) strength++;

      const colors = ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#16a34a'];
      const labels = ['Muito fraca', 'Fraca', 'Média', 'Forte', 'Muito forte'];

      fill.style.width = `${(strength / 5) * 100}%`;
      fill.style.backgroundColor = colors[strength - 1] || '#ef4444';
      text.textContent = labels[strength - 1] || 'Muito fraca';
      text.style.color = colors[strength - 1] || '#ef4444';
    });

    // LOGIN
    document.getElementById('login-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const btn = document.getElementById('login-btn');

      if (!email || !password) {
        showAlert('login', 'Por favor, preencha todos os campos');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Entrando...';

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ 
          email, 
          password 
        });

        if (error) {
          throw error;
        }

        showAlert('login', 'Login realizado com sucesso!', 'success');
        
        // Salvar dados do usuário
        const userData = {
          id: data.user.id,
          email: data.user.email,
          user_metadata: data.user.user_metadata
        };
        
        // Simular redirecionamento (você pode alterar para sua página)
        setTimeout(() => {
          alert('Redirecionando para a loja... (você pode alterar este comportamento)');
        }, 1500);

      } catch (error) {
        let errorMessage = 'Erro ao fazer login';
        
        if (error.message === 'Invalid login credentials') {
          errorMessage = 'Email ou senha incorretos';
        } else if (error.message === 'Email not confirmed') {
          errorMessage = 'Por favor, confirme seu email antes de fazer login';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showAlert('login', errorMessage);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Entrar';
      }
    });

    // CADASTRO
    document.getElementById('register-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const confirm = document.getElementById('register-confirm').value;
      const btn = document.getElementById('register-btn');

      if (!name || !email || !password || !confirm) {
        showAlert('register', 'Por favor, preencha todos os campos');
        return;
      }

      if (password !== confirm) {
        showAlert('register', 'As senhas não coincidem');
        return;
      }

      if (password.length < 6) {
        showAlert('register', 'A senha deve ter pelo menos 6 caracteres');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Verificando email...';

      try {
        // Verificar se o email já existe
        const emailExists = await checkEmailExists(email);
        
        if (emailExists) {
          showAlert('register', 'Este email já está cadastrado. Tente fazer login ou use outro email.');
          return;
        }

        btn.innerHTML = '<span class="loading"></span> Criando conta...';

        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: { 
              full_name: name 
            },
            emailRedirectTo: 'https://novaviberoleplay.netlify.app/contaconfirma.html'
          }
        });

        if (error) {
          throw error;
        }

        showAlert('register', 'Conta criada com sucesso! Verifique seu email para confirmar.', 'success');
        
        // Limpar formulário
        document.getElementById('register-form-element').reset();
        
        // Resetar indicador de força da senha
        document.getElementById('strength-fill').style.width = '0%';
        document.getElementById('strength-text').textContent = 'Muito fraca';

      } catch (error) {
        let errorMessage = 'Erro ao criar conta';
        
        if (error.message === 'User already registered') {
          errorMessage = 'Este email já está cadastrado. Tente fazer login ou use outro email.';
        } else if (error.message === 'Password should be at least 6 characters') {
          errorMessage = 'A senha deve ter pelo menos 6 caracteres';
        } else if (error.message === 'Signup is disabled') {
          errorMessage = 'Cadastro temporariamente desabilitado. Tente novamente mais tarde.';
        } else if (error.message === 'Invalid email') {
          errorMessage = 'Por favor, digite um email válido';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showAlert('register', errorMessage);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Criar conta';
      }
    });

    // ESQUECI A SENHA
    document.getElementById('forgot-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('forgot-email').value;
      const btn = document.getElementById('forgot-btn');

      if (!email) {
        showAlert('forgot', 'Por favor, digite seu email');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Enviando...';

      try {
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://novaviberoleplay.netlify.app/reset.html'
        });

        if (error) {
          throw error;
        }

        showAlert('forgot', 'Email de recuperação enviado! Verifique sua caixa de entrada.', 'success');
        
        // Limpar campo
        document.getElementById('forgot-email').value = '';

      } catch (error) {
        let errorMessage = 'Erro ao enviar email de recuperação';
        
        if (error.message) {
          errorMessage = error.message;
        }
        
        showAlert('forgot', errorMessage);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Enviar link de recuperação';
      }
    });

    // Verificar se o usuário já está logado
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        console.log('Usuário logado:', session.user);
      } else if (event === 'SIGNED_OUT') {
        console.log('Usuário deslogado');
      }
    });
  </script>
</body>
</html>
