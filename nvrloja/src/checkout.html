<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout — Nova Vibe RP</title>
  <style>
    body { background: #121216; color: #fff; font-family: sans-serif; padding: 20px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; }
    .qr-code img { max-width: 250px; margin: 20px auto; display: block; }
    .pix-code { background: #222; padding: 10px; word-break: break-all; margin: 10px 0; }
    .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .success { background: #27ae60; color: #fff; }
    .error { background: #e74c3c; color: #fff; }
    .pending { background: #f1c40f; color: #000; }
  </style>
</head>
<body>

  <h1>Nova Vibe RP — Checkout</h1>

  <div>
    <label>Nome:</label>
    <input type="text" id="nome">
    <label>Email:</label>
    <input type="email" id="email">
    <label>Telefone:</label>
    <input type="text" id="telefone">
    <label>Discord:</label>
    <input type="text" id="discord">
    <label>ID do Jogador:</label>
    <input type="number" id="idJogador">
    <label>Personagem:</label>
    <input type="text" id="personagem">
    <button onclick="processPayment()">Pagar via PIX</button>
  </div>

  <div id="payment-area" style="display:none;">
    <div class="qr-code" id="qr-code"></div>
    <div class="pix-code" id="pix-code"></div>
    <div id="status" class="status pending">Aguardando pagamento...</div>
  </div>

  <script>
    const functionURL = 'https://czsnjdoxguldtznixcdj.supabase.co/functions/v1/create_payment';
    let checkInterval = null;

    function generateReference() {
      return 'NVRP_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    }

    async function processPayment() {
      const paymentData = {
        transaction_amount: 44.90,
        description: 'Nova Vibe RP - VIP Mensal + 500k Dinheiro',
        payer: {
          email: document.getElementById('email').value,
          first_name: document.getElementById('nome').value.split(' ')[0],
          last_name: document.getElementById('nome').value.split(' ').slice(1).join(' ') || 'Cliente'
        },
        external_reference: generateReference(),
        metadata: {
          discord: document.getElementById('discord').value,
          telefone: document.getElementById('telefone').value,
          id_jogador: document.getElementById('idJogador').value,
          personagem: document.getElementById('personagem').value
        }
      };

      const res = await fetch(functionURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paymentData)
      });

      const data = await res.json();
      if (data.status !== 'pending') {
        alert('Erro ao criar pagamento!');
        return;
      }

      document.getElementById('payment-area').style.display = 'block';
      document.getElementById('qr-code').innerHTML = `<img src="data:image/png;base64,${data.point_of_interaction.transaction_data.qr_code_base64}">`;
      document.getElementById('pix-code').innerText = data.point_of_interaction.transaction_data.qr_code;

      checkStatus(data.id);
    }

    async function checkStatus(paymentId) {
      if (checkInterval) clearInterval(checkInterval);
      checkInterval = setInterval(async () => {
        const res = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
          headers: { Authorization: `Bearer SEU_MP_TOKEN` }
        });
        const data = await res.json();
        if (data.status === 'approved') {
          clearInterval(checkInterval);
          document.getElementById('status').innerText = '✅ Pagamento aprovado!';
          document.getElementById('status').className = 'status success';
        }
      }, 5000);
    }
  </script>

</body>
</html>
