<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout ‚Äî Nova Vibe RP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #121216; 
      color: #fff; 
      font-family: 'Segoe UI', sans-serif; 
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: #1c1e28;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      overflow: hidden;
      border: 1px solid #2f3a5a;
    }
    
    .header {
      background: linear-gradient(135deg, #2f3a5a, #3f4b76);
      padding: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .header h1 {
      font-size: 2rem;
      color: #fff;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      position: relative;
      z-index: 1;
    }
    
    .header p {
      color: #bbb;
      font-size: 1rem;
      position: relative;
      z-index: 1;
    }
    
    .content {
      padding: 40px;
    }
    
    .section {
      margin-bottom: 30px;
      background: #242836;
      border-radius: 8px;
      padding: 25px;
      border: 1px solid #2f3a5a;
      transition: all 0.3s ease;
    }
    
    .section:hover {
      border-color: #3f4b76;
      transform: translateY(-2px);
    }
    
    .section-title {
      font-size: 1.3rem;
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(to bottom, #2f3a5a, #3f4b76);
      border-radius: 2px;
    }
    
    .product-list {
      max-height: 280px;
      overflow-y: auto;
      background: #1a1c24;
      border-radius: 6px;
      padding: 15px;
      border: 1px solid #2f3a5a;
    }
    
    .product-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .product-list::-webkit-scrollbar-track {
      background: #1a1c24;
      border-radius: 4px;
    }
    
    .product-list::-webkit-scrollbar-thumb {
      background: #2f3a5a;
      border-radius: 4px;
    }
    
    .product-list::-webkit-scrollbar-thumb:hover {
      background: #3f4b76;
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #2f3a5a;
      transition: all 0.3s ease;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-item:hover {
      background: rgba(47, 58, 90, 0.1);
      padding-left: 10px;
      border-radius: 4px;
    }
    
    .product-info {
      flex: 1;
    }
    
    .product-name {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    
    .product-quantity {
      font-size: 0.9rem;
      color: #bbb;
    }
    
    .product-price {
      font-weight: bold;
      color: #2f3a5a;
      font-size: 1.1rem;
    }
    
    .total-section {
      background: linear-gradient(135deg, #2f3a5a, #3f4b76);
      border: none;
      color: #fff;
      text-align: center;
    }
    
    .total-amount {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #2f3a5a;
      border-radius: 6px;
      background: #1a1c24;
      color: #fff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #3f4b76;
      background: #242836;
      box-shadow: 0 0 0 3px rgba(47, 58, 90, 0.2);
    }
    
    .form-group input::placeholder {
      color: #666;
    }
    
    .pay-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #2f3a5a, #3f4b76);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .pay-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .pay-button:hover::before {
      left: 100%;
    }
    
    .pay-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(47, 58, 90, 0.4);
    }
    
    .pay-button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .pay-button:disabled::before {
      display: none;
    }
    
    .payment-area {
      margin-top: 20px;
      text-align: center;
    }
    
    .qr-code {
      margin: 20px 0;
    }
    
    .qr-code img {
      max-width: 280px;
      border: 3px solid #2f3a5a;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .qr-code img:hover {
      border-color: #3f4b76;
      transform: scale(1.02);
    }
    
    .pix-code {
      background: #1a1c24;
      padding: 15px;
      word-break: break-all;
      margin: 20px 0;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      position: relative;
      border: 1px solid #2f3a5a;
    }
    
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2f3a5a;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .copy-btn:hover {
      background: #3f4b76;
      transform: translateY(-1px);
    }
    
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 6px;
      font-weight: 600;
      text-align: center;
      border: 1px solid;
    }
    
    .status.success {
      background: rgba(39, 174, 96, 0.1);
      border-color: #27ae60;
      color: #27ae60;
    }
    
    .status.error {
      background: rgba(231, 76, 60, 0.1);
      border-color: #e74c3c;
      color: #e74c3c;
    }
    
    .status.pending {
      background: rgba(241, 196, 15, 0.1);
      border-color: #f1c40f;
      color: #f1c40f;
    }
    
    .status.info {
      background: rgba(52, 152, 219, 0.1);
      border-color: #3498db;
      color: #3498db;
    }
    
    .payment-instructions {
      background: #242836;
      border-radius: 6px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid #2f3a5a;
    }
    
    .payment-instructions h4 {
      color: #fff;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    
    .payment-instructions p {
      color: #bbb;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .payment-instructions p:last-child {
      margin-bottom: 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #2f3a5a;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .back-button:hover {
      background: #3f4b76;
      transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 8px;
      }
      
      .header {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .content {
        padding: 20px;
      }
      
      .section {
        padding: 20px;
      }
      
      .total-amount {
        font-size: 1.5rem;
      }
      
      .qr-code img {
        max-width: 240px;
      }
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="window.history.back()">‚Üê Voltar</button>
  
  <div class="container">
    <div class="header">
      <h1>üõí Finalizar Compra</h1>
      <p>Revise seus itens e complete o pagamento</p>
    </div>

    <div class="content">
      <div class="section">
        <h3 class="section-title">üì¶ Seus Itens</h3>
        <div class="product-list" id="product-list">
          <!-- Itens do carrinho v√£o aqui -->
        </div>
      </div>

      <div class="section total-section">
        <div class="total-amount" id="total-value">Total: R$ 0,00</div>
        <p>Pagamento via PIX instant√¢neo</p>
      </div>

      <div class="section" id="form-area">
        <h3 class="section-title">üë§ Dados do Cliente</h3>
        
        <div class="form-group">
          <label for="nome">Nome Completo:</label>
          <input type="text" id="nome" placeholder="Digite seu nome completo" required>
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="seu@email.com" required>
        </div>

        <div class="form-group">
          <label for="telefone">Telefone:</label>
          <input type="text" id="telefone" placeholder="(11) 99999-9999" required>
        </div>

        <div class="form-group">
          <label for="discord">Discord:</label>
          <input type="text" id="discord" placeholder="SeuNome#1234" required>
        </div>

        <div class="form-group">
          <label for="idJogador">ID do Jogador:</label>
          <input type="number" id="idJogador" placeholder="123456" required>
        </div>

        <div class="form-group">
          <label for="personagem">Nome do Personagem:</label>
          <input type="text" id="personagem" placeholder="Nome do seu personagem" required>
        </div>

        <button class="pay-button" id="payBtn" onclick="processPayment()">
          <span id="btnText">üî• Pagar via PIX</span>
          <span id="btnLoading" class="loading" style="display:none;"></span>
        </button>
      </div>

      <div class="section payment-area" id="payment-area" style="display:none;">
        <h3 class="section-title">üí≥ Pagamento PIX</h3>
        <div id="qr-code" class="qr-code"></div>
        <div id="pix-code" class="pix-code">
          <button class="copy-btn" onclick="copyPixCode()">Copiar</button>
          <span id="pix-text"></span>
        </div>
        <div id="status" class="status pending">‚è≥ Aguardando pagamento...</div>
        
        <div class="payment-instructions">
          <h4>üì± Como pagar:</h4>
          <p>1Ô∏è‚É£ Abra o app do seu banco</p>
          <p>2Ô∏è‚É£ Escaneie o QR Code ou cole o c√≥digo PIX</p>
          <p>3Ô∏è‚É£ Confirme o pagamento</p>
          <p>‚ö° O pagamento √© processado instantaneamente</p>
        </div>
      </div>
    </div>
  </div>

<script>
  // URLs e token da API (substitua pelos seus)
  const createPaymentURL = 'https://czsnjdoxguldtznixcdj.supabase.co/functions/v1/create_payment';
  const checkPaymentURL = 'https://czsnjdoxguldtznixcdj.supabase.co/functions/v1/check_payment';
  const API_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6c25qZG94Z3VsZHR6bml4Y2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMzI0NTAsImV4cCI6MjA2NzYwODQ1MH0.PCTVMRqrDD-5jsTXwQOHZP-uuNBwjbcjlfOZBidRcaU';

  let checkInterval = null;
  let currentPaymentId = null;

  // Fun√ß√£o para carregar carrinho do localStorage e mostrar na tela
  function carregarCarrinho() {
    const carrinhoSalvo = localStorage.getItem('carrinho');
    if (!carrinhoSalvo) {
      alert('Carrinho vazio! Volte para a loja e adicione produtos.');
      window.location.href = 'index.html';
      return null;
    }

    const carrinho = JSON.parse(carrinhoSalvo);
    if (!carrinho.length) {
      alert('Carrinho vazio! Volte para a loja e adicione produtos.');
      window.location.href = 'index.html';
      return null;
    }

    const productList = document.getElementById('product-list');
    productList.innerHTML = '';

    let total = 0;
    carrinho.forEach(item => {
      const div = document.createElement('div');
      div.className = 'product-item';
      
      const valorTotalItem = item.preco * item.quantidade;
      
      div.innerHTML = `
        <div class="product-info">
          <div class="product-name">${item.produto}</div>
          <div class="product-quantity">Quantidade: ${item.quantidade}</div>
        </div>
        <div class="product-price">R$ ${valorTotalItem.toFixed(2).replace('.', ',')}</div>
      `;
      
      productList.appendChild(div);
      total += valorTotalItem;
    });

    document.getElementById('total-value').textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;

    return { carrinho, total };
  }

  // Fun√ß√£o para carregar dados do cliente do localStorage e preencher formul√°rio
  function carregarDadosCliente() {
    const cliente = JSON.parse(localStorage.getItem('cliente'));
    if (!cliente) {
      alert('Cliente n√£o encontrado. Fa√ßa login antes de continuar.');
      window.location.href = 'login.html';
      return null;
    }
    document.getElementById('nome').value = cliente.nome || '';
    document.getElementById('email').value = cliente.email || '';
    document.getElementById('telefone').value = cliente.telefone || '';
    document.getElementById('discord').value = cliente.discord || '';
    document.getElementById('idJogador').value = cliente.idJogador || '';
    document.getElementById('personagem').value = cliente.personagem || '';
    return cliente;
  }

  // Valida√ß√£o simples do formul√°rio
  function validateForm() {
    const fields = ['nome', 'email', 'telefone', 'discord', 'idJogador', 'personagem'];
    for (let field of fields) {
      const value = document.getElementById(field).value.trim();
      if (!value) {
        alert(`Por favor, preencha o campo ${field}`);
        document.getElementById(field).focus();
        return false;
      }
    }
    // Email regex
    const email = document.getElementById('email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('Por favor, insira um email v√°lido');
      document.getElementById('email').focus();
      return false;
    }
    return true;
  }

  // Controle bot√£o loading
  function setLoading(loading) {
    const btn = document.getElementById('payBtn');
    const btnText = document.getElementById('btnText');
    const btnLoading = document.getElementById('btnLoading');
    if (loading) {
      btn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-block';
    } else {
      btn.disabled = false;
      btnText.style.display = 'inline-block';
      btnLoading.style.display = 'none';
    }
  }

  // Gera uma refer√™ncia √∫nica para a compra
  function generateReference() {
    return 'NVR-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  }

  // Fun√ß√£o principal para processar pagamento
  async function processPayment() {
    // Validar formul√°rio
    if (!validateForm()) return;

    // Carregar dados
    const dadosCarrinho = carregarCarrinho();
    if (!dadosCarrinho) return;

    const cliente = carregarDadosCliente();
    if (!cliente) return;

    // Preparar dados para envio
    const paymentData = {
      reference: generateReference(),
      amount: dadosCarrinho.total,
      customer: {
        name: document.getElementById('nome').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('telefone').value,
        discord: document.getElementById('discord').value,
        playerId: document.getElementById('idJogador').value,
        character: document.getElementById('personagem').value
      },
      items: dadosCarrinho.carrinho
    };

    setLoading(true);

    try {
      // Criar pagamento
      const response = await fetch(createPaymentURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_TOKEN}`
        },
        body: JSON.stringify(paymentData)
      });

      const result = await response.json();
      
      if (result.success) {
        currentPaymentId = result.payment_id;
        
        // Mostrar QR Code e c√≥digo PIX
        document.getElementById('form-area').style.display = 'none';
        document.getElementById('payment-area').style.display = 'block';
        
        // QR Code
        const qrCodeDiv = document.getElementById('qr-code');
        qrCodeDiv.innerHTML = `<img src="${result.qr_code}" alt="QR Code PIX">`;
        
        // C√≥digo PIX
        document.getElementById('pix-text').textContent = result.pix_code;
        
        // Iniciar verifica√ß√£o de pagamento
        startPaymentCheck();
      } else {
        alert('Erro ao gerar pagamento: ' + result.message);
      }
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao processar pagamento. Tente novamente.');
    } finally {
      setLoading(false);
    }
  }

  // Fun√ß√£o para verificar status do pagamento
  async function startPaymentCheck() {
    checkInterval = setInterval(async () => {
      try {
        const response = await fetch(checkPaymentURL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_TOKEN}`
          },
          body: JSON.stringify({ payment_id: currentPaymentId })
        });

        const result = await response.json();
        
        if (result.status === 'paid') {
          clearInterval(checkInterval);
          document.getElementById('status').className = 'status success';
          document.getElementById('status').innerHTML = '‚úÖ Pagamento confirmado!';
          
          // Limpar carrinho
          localStorage.removeItem('carrinho');
          
          setTimeout(() => {
            alert('Pagamento confirmado! Seus itens ser√£o entregues em breve.');
            window.location.href = 'index.html';
          }, 2000);
        } else if (result.status === 'expired') {
          clearInterval(checkInterval);
          document.getElementById('status').className = 'status error';
          document.getElementById('status').innerHTML = '‚ùå Pagamento expirado';
        }
      } catch (error) {
        console.error('Erro ao verificar pagamento:', error);
      }
    }, 5000); // Verifica a cada 5 segundos
  }

  // Fun√ß√£o para copiar c√≥digo PIX
  function copyPixCode() {
    const pixCode = document.getElementById('pix-text').textContent;
    navigator.clipboard.writeText(pixCode).then(() => {
      const copyBtn = document.querySelector('.copy-btn');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copiado!';
      copyBtn.style.background = '#27ae60';
      
      setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.style.background = '#2f3a5a';
      }, 2000);
    });
  }

  // Inicializar p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    carregarCarrinho();
    carregarDadosCliente();
  });

  // Limpar interval quando a p√°gina for fechada
  window.addEventListener('beforeunload', function() {
    if (checkInterval) {
      clearInterval(checkInterval);
    }
  });
</script>

</body>
</html>
