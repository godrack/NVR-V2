<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checkout PIX - Nova Vibe RP</title>
<style>
  body { background: #121216; color: #fff; font-family: 'Segoe UI', sans-serif; padding: 20px; }
  #qr-code-container { margin-top: 30px; text-align: center; }
  #qr-code-img { max-width: 300px; border-radius: 8px; }
  #status { margin-top: 20px; font-size: 1.1rem; }
  button { background: #2f3a5a; color: #fff; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; }
  button:hover { background: #3f4b76; }
</style>
</head>
<body>

<h1>Checkout - Pagamento PIX</h1>
<button id="btn-pagar">Gerar QR Code e Pagar</button>

<div id="qr-code-container" style="display:none;">
  <h3>Escaneie o QR Code abaixo com seu app de banco para pagar:</h3>
  <img id="qr-code-img" alt="QR Code PIX" />
  <p id="status">Aguardando pagamento...</p>
</div>

<script>
  const btnPagar = document.getElementById('btn-pagar');
  const qrContainer = document.getElementById('qr-code-container');
  const qrCodeImg = document.getElementById('qr-code-img');
  const statusText = document.getElementById('status');

  btnPagar.addEventListener('click', async () => {
    // Pega carrinho do localStorage
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');

    if (!carrinho.length) {
      alert('Seu carrinho estÃ¡ vazio!');
      return;
    }

    const items = carrinho.map(item => ({
      title: item.produto,
      quantity: item.quantidade,
      unit_price: item.preco,
      currency_id: 'BRL'
    }));

    try {
      btnPagar.disabled = true;
      btnPagar.textContent = 'Gerando QR Code...';

      const response = await fetch('/create_preference', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });

      const data = await response.json();

      if (data.qr_code) {
        qrCodeImg.src = 'data:image/png;base64,' + data.qr_code;
        qrContainer.style.display = 'block';
        btnPagar.style.display = 'none';

        // Aqui pode implementar polling para status do pagamento
      } else if (data.init_point) {
        window.location.href = data.init_point;
      } else {
        alert('Erro ao gerar QR Code');
        btnPagar.disabled = false;
        btnPagar.textContent = 'Gerar QR Code e Pagar';
      }
    } catch (err) {
      alert('Erro ao comunicar com o servidor');
      console.error(err);
      btnPagar.disabled = false;
      btnPagar.textContent = 'Gerar QR Code e Pagar';
    }
  });
</script>

</body>
</html>
